#!/bin/bash
set -e

BUILD_DIR=$1
CACHE_DIR=$2

echo ">>> Installing dependencies..."
apt-get update && apt-get install -y \
    git \
    make \
    g++ \
    pkg-config \
    libssl-dev \
    libminizip-dev \
    zlib1g-dev \
    libbz2-dev \
    liblzma-dev \
    libzstd-dev \
    && rm -rf /var/lib/apt/lists/*

echo ">>> Cloning and building zsign..."
TMP_BUILD_DIR=$(mktemp -d)

git clone https://github.com/zhlynn/zsign.git "$TMP_BUILD_DIR/zsign"
cd "$TMP_BUILD_DIR/zsign/build/linux"

make clean
make

echo ">>> Moving zsign to bin directory..."
mkdir -p "$BUILD_DIR/bin"
cp zsign "$BUILD_DIR/bin/"
chmod +x "$BUILD_DIR/bin/zsign"

echo ">>> zsign built and installed at $BUILD_DIR/bin/zsign"
